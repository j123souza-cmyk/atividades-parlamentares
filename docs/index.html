<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Atividades Parlamentares</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 16px; }
nav button { margin-right: 8px; padding: 8px 12px; cursor: pointer; }

.aba { display: none; }
.ativa { display: block; }

.deputado {
  display: flex;
  gap: 10px;
  border-bottom: 1px solid #ddd;
  padding: 8px 0;
  cursor: pointer;
}
.deputado img { width: 60px; border-radius: 6px; }

table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }
th { background: #f0f0f0; }

button.sec { padding: 4px 8px; }
.votos { background: #fafafa; margin: 10px 0; padding: 10px; }
.aviso { color: #777; font-style: italic; }
</style>
</head>
<body>

<h1>Atividades Parlamentares</h1>

<nav>
  <button onclick="mostrar('lista')">Deputados</button>
  <button onclick="mostrar('ranking')">Ranking Presença</button>
  <button onclick="mostrar('votacoes')">Votações</button>
</nav>

<section id="lista" class="aba ativa">
<p id="status">Carregando deputados...</p>
<div id="listaDeputados"></div>
</section>

<section id="ranking" class="aba">
<p id="statusRanking">Clique em gerar ranking</p>
<button onclick="gerarRanking()">Gerar ranking</button>
<div id="rankingResultado"></div>
</section>

<section id="detalhe" class="aba">
<h2 id="nomeDeputado"></h2>
<img id="fotoDeputado" width="120">
<p id="presencaTexto"></p>
<canvas id="grafico"></canvas>
</section>

<section id="votacoes" class="aba">
<h2>Últimas votações em Plenário</h2>
<p id="statusVotacoes">Carregando votações...</p>
<div id="listaVotacoes"></div>
</section>

<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";

/* ---------- UTIL ---------- */
function mostrar(id) {
  document.querySelectorAll('.aba').forEach(a => a.classList.remove('ativa'));
  document.getElementById(id).classList.add('ativa');

  if (id === 'votacoes' && !window.votacoesCarregadas) {
    carregarVotacoes();
    window.votacoesCarregadas = true;
  }
}

/* ---------- VOTAÇÕES ---------- */
async function carregarVotacoes() {
  const status = document.getElementById('statusVotacoes');

  try {
    const r = await fetch(
      `${BASE}/votacoes?ordem=DESC&ordenarPor=dataHoraRegistro&itens=10`
    );
    const j = await r.json();

    status.remove();
    j.dados.forEach(v => renderizarVotacao(v));

  } catch (e) {
    status.innerText = "Erro ao carregar votações";
  }
}

function renderizarVotacao(v) {
  const div = document.createElement('div');
  div.className = "votos";

  div.innerHTML = `
    <strong>${v.descricao || 'Votação'}</strong><br>
    <small>
      ${new Date(v.dataHoraRegistro).toLocaleString('pt-BR')} —
      Tipo: ${v.tipoVotacao}
    </small><br>
    Resultado: <b>${v.aprovacao || 'Não informado'}</b><br>
  `;

  if (v.tipoVotacao === "NOMINAL") {
    const btn = document.createElement('button');
    btn.className = "sec";
    btn.innerText = "Ver votos";
    btn.onclick = () => carregarVotos(v.id, div);
    div.appendChild(btn);
  } else {
    div.innerHTML += `<p class="aviso">Votação simbólica — não há votos individuais.</p>`;
  }

  listaVotacoes.appendChild(div);
}

async function carregarVotos(id, container) {
  container.innerHTML += "<p>Carregando votos...</p>";

  const r = await fetch(`${BASE}/votacoes/${id}/votos`);
  const j = await r.json();

  const tabela = document.createElement('table');
  tabela.innerHTML = `
    <tr>
      <th>Deputado</th>
      <th>Partido</th>
      <th>UF</th>
      <th>Voto</th>
    </tr>
  `;

  j.dados.forEach(v => {
    tabela.innerHTML += `
      <tr>
        <td>${v.deputado_.nome}</td>
        <td>${v.deputado_.siglaPartido}</td>
        <td>${v.deputado_.siglaUf}</td>
        <td>${v.tipoVoto}</td>
      </tr>
    `;
  });

  container.appendChild(tabela);
}
</script>
</body>
</html>
