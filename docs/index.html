<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Atividades Parlamentares</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:16px; }
nav button { margin-right:8px; padding:8px 12px; cursor:pointer; }

.aba { display:none; }
.ativa { display:block; }

.deputado {
  display:flex; gap:10px; border-bottom:1px solid #ddd;
  padding:8px 0; cursor:pointer;
}
.deputado img { width:60px; border-radius:6px; }

details {
  border:1px solid #ddd;
  border-radius:6px;
  padding:8px;
  margin-bottom:8px;
  background:#fafafa;
}

summary {
  cursor:pointer;
  font-weight:bold;
  list-style:none;
}

summary::before {
  content:"üîó ";
}

.presenca { margin:10px 0; font-weight:bold; }

</style>
</head>

<body>

<h1>Atividades Parlamentares</h1>

<nav>
<button onclick="mostrar('lista')">Deputados</button>
<button onclick="mostrar('detalhe')">Detalhes</button>
</nav>

<section id="lista" class="aba ativa">
<div id="listaDeputados"></div>
</section>

<section id="detalhe" class="aba">
<h2 id="nomeDeputado"></h2>
<img id="fotoDeputado" width="120">
<p class="presenca" id="presencaTexto"></p>
<canvas id="grafico" width="420" height="280"></canvas>

<h3>üìÑ Proposi√ß√µes Apresentadas</h3>
<div id="proposicoesApresentadas"></div>

<h3>üìë Rela√ß√£o de Vota√ß√µes</h3>
<div id="proposicoesVotadas"></div>
</section>

<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";
let deputados = [];
let chart = null;

function mostrar(id){
  document.querySelectorAll('.aba').forEach(a=>a.classList.remove('ativa'));
  document.getElementById(id).classList.add('ativa');
}

/* LISTA */
fetch(`${BASE}/deputados?ordenarPor=nome`)
.then(r=>r.json())
.then(j=>{
  deputados=j.dados;
  const el=document.getElementById('listaDeputados');
  deputados.forEach(d=>{
    const div=document.createElement('div');
    div.className='deputado';
    div.innerHTML=`
      <img src="${d.urlFoto}">
      <div>
        <strong>${d.nome}</strong><br>
        ${d.siglaPartido} - ${d.siglaUf}
      </div>`;
    div.onclick=()=>abrirDetalhe(d);
    el.appendChild(div);
  });
});

async function abrirDetalhe(dep){
  mostrar('detalhe');
  nomeDeputado.innerText=dep.nome;
  fotoDeputado.src=dep.urlFoto;

  const pres=await calcularPresenca(dep.id);
  presencaTexto.innerText=`Presen√ßa estimada: ${pres.presenca}%`;
  desenharGrafico(pres.total, pres.plenario);

  const apres=await buscarProposicoesApresentadas(dep.id);
  const votos=await buscarProposicoesVotadas(dep.id);

  renderAcordion(apres, 'proposicoesApresentadas', false);
  renderAcordion(votos, 'proposicoesVotadas', true);
}

/* ACORDION */
function renderAcordion(lista, alvo, isVotacao){
  const container=document.getElementById(alvo);
  container.innerHTML="";

  if(lista.length===0){
    container.innerHTML="<em>Nenhum registro no per√≠odo.</em>";
    return;
  }

  lista.forEach(p=>{
    const el=document.createElement('details');
    el.innerHTML=`
      <summary>${p.siglaTipo} ${p.numero}/${p.ano}</summary>
      <p><strong>Ementa:</strong> ${p.ementa||"N√£o informada"}</p>
      ${isVotacao ? `<p><strong>Posicionamento:</strong> ${p.voto}</p>` : ""}
    `;
    container.appendChild(el);
  });
}

/* PRESEN√áA */
async function calcularPresenca(id){
  const fim=new Date();
  const ini=new Date(); ini.setFullYear(fim.getFullYear()-1);
  const r=await fetch(`${BASE}/deputados/${id}/eventos?dataInicio=${ini.toISOString().slice(0,10)}&dataFim=${fim.toISOString().slice(0,10)}&itens=1000`);
  const ev=(await r.json()).dados||[];
  const pl=ev.filter(e=>(e.descricao||"").toLowerCase().includes("plen√°rio")).length;
  return { presenca: ev.length?Math.round(pl/ev.length*100):0, total:ev.length, plenario:pl };
}

/* PROPOSI√á√ïES APRESENTADAS */
async function buscarProposicoesApresentadas(id){
  const r=await fetch(`${BASE}/proposicoes?autorId=${id}&itens=20`);
  return (await r.json()).dados||[];
}

/* VOTA√á√ïES */
async function buscarProposicoesVotadas(id){
  const r=await fetch(`${BASE}/deputados/${id}/votacoes?itens=200`);
  const dados=(await r.json()).dados||[];
  const lista=[];

  for(const v of dados){
    const det=await fetch(`${BASE}/votacoes/${v.id}`);
    const vd=(await det.json()).dados;
    if(!vd) continue;

    const voto=vd.deputadosVotos?.find(d=>d.deputadoId==id);
    if(!voto) continue;

    vd.proposicoesAfetadas?.forEach(p=>{
      lista.push({
        siglaTipo:p.siglaTipo,
        numero:p.numero,
        ano:p.ano,
        ementa:p.ementa,
        voto:voto.voto
      });
    });
  }
  return lista;
}

/* GR√ÅFICO */
function desenharGrafico(total, pl){
  if(chart) chart.destroy();
  chart=new Chart(grafico,{
    type:'bar',
    data:{ labels:['Eventos','Plen√°rio'], datasets:[{data:[total,pl]}] },
    options:{ responsive:false }
  });
}
</script>

</body>
</html>
