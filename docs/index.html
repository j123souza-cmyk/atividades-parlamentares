<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Atividades Parlamentares</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 16px; }
nav button { margin-right: 6px; padding: 8px; }
.aba { display: none; }
.ativa { display: block; }
.filtros select, .filtros input { margin-right: 6px; padding: 4px; }
.deputado {
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid #ddd;
  padding: 8px;
  cursor: pointer;
}
.deputado img { width: 60px; border-radius: 6px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
th { background: #f0f0f0; }
canvas { max-width: 500px; margin-top: 20px; }
</style>
</head>

<body>

<h1>Atividades Parlamentares</h1>

<nav>
  <button onclick="mostrar('lista')">Deputados</button>
  <button onclick="mostrar('ranking')">Ranking</button>
</nav>

<div class="filtros">
  <input type="text" id="fNome" placeholder="Nome" oninput="aplicarFiltros()">
  <select id="fPartido" onchange="aplicarFiltros()">
    <option value="">Partido</option>
  </select>
  <select id="fUf" onchange="aplicarFiltros()">
    <option value="">UF</option>
  </select>
</div>

<section id="lista" class="aba ativa">
  <div id="listaDeputados"></div>
  <canvas id="grafico"></canvas>
</section>

<section id="ranking" class="aba">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Deputado</th>
        <th>Partido</th>
        <th>Proposições (12 meses)</th>
      </tr>
    </thead>
    <tbody id="rankingBody"></tbody>
  </table>
</section>

<script>
const API = "https://dadosabertos.camara.leg.br/api/v2";
const hoje = new Date();
const umAnoAtras = new Date();
umAnoAtras.setFullYear(hoje.getFullYear() - 1);

let deputados = [];
let proposicoes = {};
let grafico = null;

function mostrar(id) {
  document.querySelectorAll('.aba').forEach(a => a.classList.remove('ativa'));
  document.getElementById(id).classList.add('ativa');
}

async function carregarDeputados() {
  const r = await fetch(`${API}/deputados?ordenarPor=nome&itens=100`);
  const j = await r.json();
  deputados = j.dados;
  preencherFiltros();
  carregarProposicoes();
}

function preencherFiltros() {
  const partidos = [...new Set(deputados.map(d => d.siglaPartido))].sort();
  const ufs = [...new Set(deputados.map(d => d.siglaUf))].sort();

  partidos.forEach(p => fPartido.innerHTML += `<option>${p}</option>`);
  ufs.forEach(u => fUf.innerHTML += `<option>${u}</option>`);
}

async function carregarProposicoes() {
  for (const d of deputados) {
    const url = `${API}/proposicoes?idAutor=${d.id}&dataInicio=${umAnoAtras.toISOString().split('T')[0]}&itens=100`;
    const r = await fetch(url);
    const j = await r.json();
    proposicoes[d.id] = j.dados.length;
  }
  aplicarFiltros();
}

function aplicarFiltros() {
  const nome = fNome.value.toLowerCase();
  const partido = fPartido.value;
  const uf = fUf.value;

  const filtrados = deputados.filter(d =>
    d.nome.toLowerCase().includes(nome) &&
    (partido === "" || d.siglaPartido === partido) &&
    (uf === "" || d.siglaUf === uf)
  );

  renderLista(filtrados);
  renderRanking(filtrados);
}

function renderLista(lista) {
  listaDeputados.innerHTML = "";
  lista.forEach(d => {
    listaDeputados.innerHTML += `
      <div class="deputado" onclick="mostrarGrafico('${d.id}','${d.nome}')">
        <img src="${d.urlFoto}">
        <div>
          <strong>${d.nome}</strong><br>
          ${d.siglaPartido} - ${d.siglaUf}<br>
          ${proposicoes[d.id]} proposições
        </div>
      </div>
    `;
  });
}

function renderRanking(lista) {
  rankingBody.innerHTML = "";
  lista
    .map(d => ({ ...d, total: proposicoes[d.id] }))
    .sort((a,b) => b.total - a.total)
    .forEach((d,i) => {
      rankingBody.innerHTML += `
        <tr>
          <td>${i+1}</td>
          <td>${d.nome}</td>
          <td>${d.siglaPartido}</td>
          <td>${d.total}</td>
        </tr>
      `;
    });
}

function mostrarGrafico(id, nome) {
  if (grafico) grafico.destroy();
  grafico = new Chart(document.getElementById("grafico"), {
    type: "bar",
    data: {
      labels: ["Proposições (12 meses)"],
      datasets: [{
        label: nome,
        data: [proposicoes[id]]
      }]
    }
  });
}

carregarDeputados();
</script>

</body>
</html>
