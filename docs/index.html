<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Atividades Parlamentares</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 16px; }
nav button { margin-right: 8px; padding: 8px 12px; cursor: pointer; }

.aba { display: none; }
.ativa { display: block; }

.filtros { margin: 12px 0; }
.filtros input, .filtros select { padding: 6px; margin-right: 6px; }

.deputado {
  display: flex;
  gap: 10px;
  border-bottom: 1px solid #ddd;
  padding: 8px 0;
  cursor: pointer;
}
.deputado img { width: 60px; border-radius: 6px; }

table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; }
th { background: #f0f0f0; }

.ranking-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}
.progresso { margin: 10px 0; font-weight: bold; }
</style>
</head>
<body>

<h1>Atividades Parlamentares</h1>

<nav>
  <button onclick="mostrar('lista')">Deputados</button>
  <button onclick="mostrar('ranking')">Ranking Presença</button>
</nav>

<section id="lista" class="aba ativa">
<p id="status">Carregando deputados...</p>

<div class="filtros">
  <input id="filtroNome" placeholder="Nome" oninput="aplicarFiltros()">
  <select id="filtroPartido" onchange="aplicarFiltros()">
    <option value="">Partido</option>
  </select>
  <select id="filtroUf" onchange="aplicarFiltros()">
    <option value="">UF</option>
  </select>
</div>

<div id="listaDeputados"></div>
</section>

<section id="ranking" class="aba">
<p id="statusRanking" class="progresso">Clique em gerar ranking</p>
<button onclick="gerarRanking()">Gerar ranking</button>

<div class="ranking-container">
  <div>
    <h3>Top 20 – Maior Presença</h3>
    <table>
      <thead>
        <tr><th>#</th><th>Nome</th><th>Partido</th><th>UF</th><th>%</th></tr>
      </thead>
      <tbody id="rankingMaior"></tbody>
    </table>
  </div>
  <div>
    <h3>Top 20 – Menor Presença</h3>
    <table>
      <thead>
        <tr><th>#</th><th>Nome</th><th>Partido</th><th>UF</th><th>%</th></tr>
      </thead>
      <tbody id="rankingMenor"></tbody>
    </table>
  </div>
</div>
</section>

<section id="detalhe" class="aba">
<h2 id="nomeDeputado"></h2>
<img id="fotoDeputado" width="120">
<p id="presencaTexto"></p>
<canvas id="grafico"></canvas>
</section>

<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";
const CACHE_DIAS = 7;

let deputados = [];
let deputadosFiltrados = [];
let chart;

/* ---------- UTIL ---------- */
function mostrar(id) {
  document.querySelectorAll('.aba').forEach(a => a.classList.remove('ativa'));
  document.getElementById(id).classList.add('ativa');
}

function cacheValido(item) {
  return item && (Date.now() - item.timestamp) < (CACHE_DIAS*24*60*60*1000);
}

/* ---------- LISTA ---------- */
fetch(`${BASE}/deputados?ordem=ASC&ordenarPor=nome`)
.then(r => r.json())
.then(j => {
  document.getElementById('status').remove();
  deputados = j.dados;
  deputadosFiltrados = deputados;
  preencherFiltros(deputados);
  renderizarLista(deputados);
});

function preencherFiltros(lista) {
  [...new Set(lista.map(d => d.siglaPartido))].sort()
    .forEach(p => filtroPartido.innerHTML += `<option>${p}</option>`);
  [...new Set(lista.map(d => d.siglaUf))].sort()
    .forEach(u => filtroUf.innerHTML += `<option>${u}</option>`);
}

function aplicarFiltros() {
  deputadosFiltrados = deputados.filter(d =>
    d.nome.toLowerCase().includes(filtroNome.value.toLowerCase()) &&
    (!filtroPartido.value || d.siglaPartido === filtroPartido.value) &&
    (!filtroUf.value || d.siglaUf === filtroUf.value)
  );
  renderizarLista(deputadosFiltrados);
}

function renderizarLista(lista) {
  listaDeputados.innerHTML = "";
  lista.forEach(d => {
    const div = document.createElement('div');
    div.className = "deputado";
    div.innerHTML = `
      <img src="${d.urlFoto}">
      <div><strong>${d.nome}</strong><br>${d.siglaPartido}-${d.siglaUf}</div>
    `;
    div.onclick = () => abrirDetalhe(d);
    listaDeputados.appendChild(div);
  });
}

/* ---------- PRESENÇA ---------- */
async function calcularPresenca(dep) {
  const chave = `presenca_${dep.id}`;
  const cache = JSON.parse(localStorage.getItem(chave));
  if (cacheValido(cache)) return cache.data;

  const fim = new Date();
  const ini = new Date(); ini.setFullYear(fim.getFullYear()-1);

  const r = await fetch(
    `${BASE}/deputados/${dep.id}/eventos?dataInicio=${ini.toISOString().slice(0,10)}&dataFim=${fim.toISOString().slice(0,10)}&itens=1000`
  );
  const j = await r.json();
  const ev = j.dados || [];

  const plen = ev.filter(e =>
    (e.localCamara?.nome || "").toLowerCase().includes("plenário")
  ).length;

  const presenca = ev.length ? Math.round(plen/ev.length*100) : 0;
  const data = { presenca, total: ev.length, plenarios: plen };

  localStorage.setItem(chave, JSON.stringify({ timestamp: Date.now(), data }));
  return data;
}

/* ---------- DETALHE ---------- */
async function abrirDetalhe(dep) {
  mostrar('detalhe');

  nomeDeputado.innerText = dep.nome;
  fotoDeputado.src = dep.urlFoto;

  const r = await calcularPresenca(dep);
  presencaTexto.innerText = `Presença em plenário: ${r.presenca}%`;

  if (chart) chart.destroy();
  chart = new Chart(grafico, {
    type: 'bar',
    data: {
      labels: ['Eventos', 'Plenário'],
      datasets: [{ data: [r.total, r.plenarios] }]
    },
    options: {
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  });
}

/* ---------- RANKING ---------- */
async function gerarRanking() {
  rankingMaior.innerHTML = "";
  rankingMenor.innerHTML = "";
  statusRanking.innerText = "Calculando...";

  const dados = [];
  let i = 1;

  for (const d of deputadosFiltrados) {
    statusRanking.innerText = `Calculando ${i++}/${deputadosFiltrados.length}`;
    const r = await calcularPresenca(d);
    dados.push({ ...d, presenca: r.presenca });
  }

  dados.sort((a,b)=>b.presenca-a.presenca).slice(0,20)
    .forEach((d,i)=>rankingMaior.innerHTML +=
      `<tr><td>${i+1}</td><td>${d.nome}</td><td>${d.siglaPartido}</td><td>${d.siglaUf}</td><td>${d.presenca}%</td></tr>`);

  dados.sort((a,b)=>a.presenca-b.presenca).slice(0,20)
    .forEach((d,i)=>rankingMenor.innerHTML +=
      `<tr><td>${i+1}</td><td>${d.nome}</td><td>${d.siglaPartido}</td><td>${d.siglaUf}</td><td>${d.presenca}%</td></tr>`);

  statusRanking.innerText = "Ranking pronto (cache)";
}
</script>
</body>
</html>
