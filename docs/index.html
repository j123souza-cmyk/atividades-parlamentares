<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Atividades Parlamentares</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 16px; }
nav button { margin-right: 6px; padding: 8px; }
.aba { display: none; }
.ativa { display: block; }
.deputado { display: flex; gap: 10px; border-bottom: 1px solid #ddd; padding: 8px; cursor: pointer; }
.deputado img { width: 60px; border-radius: 6px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; }
th { background: #f0f0f0; }
#log { background:#f8f8f8; border:1px solid #ccc; padding:8px; margin-top:10px; font-size:12px }
</style>
</head>

<body>

<h1>Atividades Parlamentares</h1>

<nav>
  <button onclick="mostrar('lista')">Deputados</button>
  <button onclick="mostrar('ranking')">Ranking</button>
</nav>

<section id="lista" class="aba ativa">
  <p id="status">Carregando deputados…</p>
  <div id="listaDeputados"></div>
</section>

<section id="ranking" class="aba">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Deputado</th>
        <th>Eventos</th>
      </tr>
    </thead>
    <tbody id="rankingBody"></tbody>
  </table>
</section>

<div id="log"><strong>Log:</strong><br></div>

<script>
const API = "https://dadosabertos.camara.leg.br/api/v2";
const PROXY = "https://api.allorigins.win/raw?url=";
let deputados = [];
let eventos = {};
const LIMITE = 10;

function log(msg) {
  document.getElementById("log").innerHTML += msg + "<br>";
}

function mostrar(id) {
  document.querySelectorAll('.aba').forEach(a => a.classList.remove('ativa'));
  document.getElementById(id).classList.add('ativa');
}

async function fetchSeguro(url) {
  try {
    log("Tentando direto: " + url);
    const r = await fetch(url, { headers: { 'Accept': 'application/json' }});
    if (!r.ok) throw new Error("HTTP " + r.status);
    return await r.json();
  } catch {
    log("Falhou direto, usando proxy CORS");
    const r = await fetch(PROXY + encodeURIComponent(url));
    return await r.json();
  }
}

/* === INÍCIO === */
(async () => {
  try {
    const depJson = await fetchSeguro(`${API}/deputados?ordenarPor=nome&itens=20`);
    deputados = depJson.dados || [];

    const statusEl = document.getElementById("status");
    if (statusEl) statusEl.remove();

    renderLista();

    for (let i = 0; i < LIMITE; i++) {
      const d = deputados[i];
      log("Buscando eventos de " + d.nome);

      const evJson = await fetchSeguro(`${API}/deputados/${d.id}/eventos?itens=100`);
      eventos[d.id] = evJson.dados || [];

      renderLista();
      renderRanking();
    }

  } catch (e) {
    log("ERRO CRÍTICO: " + e.message);
  }
})();

function renderLista() {
  listaDeputados.innerHTML = "";
  deputados.slice(0, LIMITE).forEach(d => {
    const total = eventos[d.id];
    listaDeputados.innerHTML += `
      <div class="deputado">
        <img src="${d.urlFoto}">
        <div>
          <strong>${d.nome}</strong><br>
          ${total ? total.length + " eventos" : "Carregando…"}
        </div>
      </div>
    `;
  });
}

function renderRanking() {
  rankingBody.innerHTML = "";

  const rank = deputados
    .slice(0, LIMITE)
    .filter(d => eventos[d.id])
    .map(d => ({ nome: d.nome, total: eventos[d.id].length }))
    .sort((a,b) => b.total - a.total);

  rank.forEach((r,i) => {
    rankingBody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${r.nome}</td>
        <td>${r.total}</td>
      </tr>
    `;
  });
}
</script>

</body>
</html>
