<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sessões do Plenário</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.evento { padding:10px; border-bottom:1px solid #ccc; cursor:pointer }
.evento:hover { background:#f2f2f2 }
.detalhe { margin-top:10px; padding:10px; background:#fafafa; border-left:4px solid #005ea8 }
.oculto { display:none }
.proposicao { margin-bottom:16px }
.proposicao strong { display:block }
.relator { color:#005ea8; font-weight:bold }
.carregando { font-style:italic; color:#777 }
</style>
</head>

<body>

<h2>Sessões do Plenário</h2>
<div id="lista"></div>

<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";
const lista = document.getElementById("lista");

/* ======================
   CACHES GLOBAIS
====================== */
const cacheProps = {};      // proposições (autoria + situação)
const cacheSessao = {};     // sessões já carregadas

/* ======================
   CARREGAR SESSÕES
====================== */
(async function carregarSessoes() {
  const hoje = new Date();
  const inicio = new Date();
  inicio.setMonth(hoje.getMonth() - 3);

  const resp = await fetch(
    `${BASE}/eventos?dataInicio=${inicio.toISOString().slice(0,10)}&dataFim=${hoje.toISOString().slice(0,10)}&itens=50&ordenarPor=dataHoraInicio&ordem=DESC`
  );
  const dados = (await resp.json()).dados || [];

  dados.filter(e => e.titulo?.toLowerCase().includes("sessão"))
    .forEach(criarSessao);
})();

/* ======================
   CRIAR BLOCO DA SESSÃO
====================== */
function criarSessao(ev) {
  const div = document.createElement("div");
  div.className = "evento";
  div.innerHTML = `
    <strong>${new Date(ev.dataHoraInicio).toLocaleString()}</strong><br>
    Sessão do Plenário
    <div id="det-${ev.id}" class="detalhe oculto">
      <div class="lista-props carregando">Clique para carregar proposições…</div>
    </div>
  `;
  div.onclick = () => abrirSessao(ev);
  lista.appendChild(div);
}

/* ======================
   ABRIR SESSÃO
====================== */
async function abrirSessao(ev) {
  const box = document.getElementById(`det-${ev.id}`);
  box.classList.toggle("oculto");

  if (cacheSessao[ev.id] || box.classList.contains("oculto")) return;

  const container = box.querySelector(".lista-props");
  container.innerHTML = "Carregando proposições…";

  const votResp = await fetch(`${BASE}/eventos/${ev.id}/votacoes`);
  const votacoes = (await votResp.json()).dados || [];

  container.innerHTML = "";

  for (const v of votacoes) {
    let voto;
    try {
      voto = (await (await fetch(`${BASE}/votacoes/${v.id}`)).json()).dados;
    } catch { continue; }

    const relator = voto.relatores?.map(r =>
      r.nome + (r.siglaPartido ? ` (${r.siglaPartido}${r.siglaUf ? "-" + r.siglaUf : ""})` : "")
    ).join(", ");

    if (!voto?.proposicoesAfetadas?.length) {
      container.innerHTML += `<div class="proposicao"><em>Votação sem proposição vinculada</em></div>`;
      continue;
    }

    for (const p of voto.proposicoesAfetadas) {
      const prop = await obterProposicao(p);

      container.innerHTML += `
        <div class="proposicao">
          <strong>${prop.siglaTipo} ${prop.numero}/${prop.ano}</strong>
          ${prop.ementa || ""}
          <div><strong>Autoria:</strong> ${prop.autoria}</div>
          <div><strong>Situação:</strong> ${prop.situacao}</div>
          ${relator ? `<div class="relator">Relator: ${relator}</div>` : ""}
          <div><strong>Resultado:</strong> ${voto.resultado || voto.descricao || ""}</div>
        </div>
      `;
    }
  }

  cacheSessao[ev.id] = true;
}

/* ======================
   PROPOSIÇÃO (CACHE + FALLBACK)
====================== */
async function obterProposicao(p) {
  if (cacheProps[p.id]) return cacheProps[p.id];

  let autoria = "Não informada";
  let situacao = "Não informada";

  try {
    const r = await fetch(`${BASE}/proposicoes/${p.id}`);
    if (r.ok) {
      const d = (await r.json()).dados;
      situacao = d?.statusProposicao?.descricaoSituacao || situacao;
    }

    const ra = await fetch(`${BASE}/proposicoes/${p.id}/autores`);
    if (ra.ok) {
      const a = (await ra.json()).dados || [];
      autoria = a.map(x =>
        x.nome + (x.siglaPartido ? ` (${x.siglaPartido}${x.siglaUf ? "-" + x.siglaUf : ""})` : "")
      ).join(", ") || autoria;
    }
  } catch {}

  return cacheProps[p.id] = {
    ...p,
    autoria,
    situacao
  };
}
</script>

</body>
</html>
