<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sess√µes do Plen√°rio</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }

#controles {
  margin-bottom: 15px;
  display: flex;
  gap: 20px;
  align-items: center;
}

select, input {
  padding: 6px;
  font-size: 14px;
}

#contador {
  font-weight: bold;
  margin-bottom: 10px;
}

.evento {
  padding: 10px;
  border-bottom: 1px solid #ccc;
  cursor: pointer;
}

.evento:hover { background: #f2f2f2; }

.detalhe {
  margin-top: 8px;
  padding: 10px;
  background: #fafafa;
  border-left: 3px solid #005ea8;
}

.oculto { display: none; }

.proposicao { margin-bottom: 16px; }
.resultado { font-style: italic; margin: 6px 0; }
.votos { font-weight: bold; margin-top: 4px; }
.video { margin: 8px 0; }

.highlight { font-weight: bold; color: red; }
.sinaliza { color: blue; font-weight: bold; margin-left: 6px; }
</style>
</head>

<body>

<h2>√öltimas Sess√µes do Plen√°rio</h2>

<div id="controles">
  <div>
    Per√≠odo:
    <select id="periodo">
      <option value="3" selected>√öltimos 3 meses</option>
      <option value="6">√öltimos 6 meses</option>
    </select>
  </div>
  <div style="flex:1;">
    üîé <input type="text" id="buscaGeral" placeholder="Buscar texto nas sess√µes‚Ä¶" />
  </div>
</div>

<div id="contador"></div>
<div id="status">Carregando sess√µes‚Ä¶</div>
<div id="lista"></div>

<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";
const lista = document.getElementById("lista");
const status = document.getElementById("status");
const seletorPeriodo = document.getElementById("periodo");
const buscaGeral = document.getElementById("buscaGeral");
const contador = document.getElementById("contador");

// Cache
const cacheSessaoDOM = {};          // DOM pronto por sess√£o
const cacheDetalheProposicao = {};  // autoria + situa√ß√£o

let sessoesTotais = 0;
let sessoesCarregadas = 0;

/* =====================
   DETALHES DA PROPOSI√á√ÉO
===================== */
async function obterDetalhesProposicao(id) {
  if (cacheDetalheProposicao[id]) return cacheDetalheProposicao[id];

  let autoria = "Autoria n√£o informada";
  let situacao = "Situa√ß√£o n√£o informada";

  try {
    const dados = (await (await fetch(`${BASE}/proposicoes/${id}`)).json()).dados;

    if (dados?.statusProposicao?.descricaoSituacao) {
      situacao = dados.statusProposicao.descricaoSituacao;
    }

    const autores = (await (await fetch(`${BASE}/proposicoes/${id}/autores`)).json()).dados || [];
    if (autores.length) {
      autoria = autores.map(a =>
        a.nome + (a.siglaPartido ? ` (${a.siglaPartido}${a.siglaUf ? "-" + a.siglaUf : ""})` : "")
      ).join(", ");
    }
  } catch {}

  return cacheDetalheProposicao[id] = { autoria, situacao };
}

/* =====================
   BUSCAR SESS√ïES
===================== */
async function carregarSessoes() {
  lista.innerHTML = "";
  status.innerText = "Carregando sess√µes‚Ä¶";
  contador.innerText = "";

  const meses = parseInt(seletorPeriodo.value);
  const fim = new Date();
  const inicio = new Date();
  inicio.setMonth(fim.getMonth() - meses);

  let pagina = 1;
  let sessoes = [];

  while (true) {
    const dados = (await (await fetch(
      `${BASE}/eventos?dataInicio=${inicio.toISOString().slice(0,10)}&dataFim=${fim.toISOString().slice(0,10)}&ordenarPor=dataHoraInicio&ordem=DESC&pagina=${pagina}&itens=100`
    )).json()).dados || [];

    if (!dados.length) break;

    dados.forEach(ev => {
      const t = ((ev.titulo || "") + (ev.descricao || "")).toLowerCase();
      if (t.includes("sess√£o") && !t.includes("audi√™ncia")) sessoes.push(ev);
    });
    pagina++;
  }

  sessoes.sort((a,b) => new Date(b.dataHoraInicio) - new Date(a.dataHoraInicio));
  sessoesTotais = sessoes.length;
  sessoesCarregadas = 0;

  sessoes.forEach(ev => {
    criarSessao(ev);
    sinal(ev.id, true);
  });

  for (const ev of sessoes) {
    await preCarregarSessao(ev);
    sinal(ev.id, false);
    contador.innerText = `Carregando ${++sessoesCarregadas}/${sessoesTotais} sess√µes‚Ä¶`;
  }

  contador.innerText = `Conclu√≠do: ${sessoesCarregadas}/${sessoesTotais}`;
  aplicarBusca();
}

/* =====================
   SESS√ÉO
===================== */
function criarSessao(ev) {
  const div = document.createElement("div");
  div.className = "evento";
  div.id = `sessao-${ev.id}`;
  div.innerHTML = `
    <strong>${new Date(ev.dataHoraInicio).toLocaleString()}</strong>
    <span class="sinaliza"></span><br>
    Sess√£o do Plen√°rio
    <div id="det-${ev.id}" class="detalhe oculto">
      <div class="lista-props"></div>
    </div>
  `;
  div.onclick = () => abrirSessao(ev.id, ev);
  lista.appendChild(div);
}

function sinal(id, on) {
  document.querySelector(`#sessao-${id} .sinaliza`).innerText =
    on ? " ‚è≥ Carregando proposi√ß√µes‚Ä¶" : "";
}

async function preCarregarSessao(ev) {
  if (cacheSessaoDOM[ev.id]) return;

  const container = document.createElement("div");

  const votacoes = (await (await fetch(`${BASE}/eventos/${ev.id}/votacoes`)).json()).dados || [];
  for (const v of votacoes) {
    const voto = (await (await fetch(`${BASE}/votacoes/${v.id}`)).json()).dados;
    if (!voto?.proposicoesAfetadas) continue;

    const relator = voto.relatores?.map(r =>
      r.nome + (r.siglaPartido ? ` (${r.siglaPartido}${r.siglaUf ? "-" + r.siglaUf : ""})` : "")
    ).join(", ") || "";

    for (const p of voto.proposicoesAfetadas) {
      const det = await obterDetalhesProposicao(p.id);
      const div = document.createElement("div");
      div.className = "proposicao";
      div.innerHTML = `
        ‚û°Ô∏è <strong>${p.siglaTipo} ${p.numero}/${p.ano}</strong><br>
        ${p.ementa || ""}<br>
        <strong>Autoria:</strong> ${det.autoria}<br>
        <strong>Situa√ß√£o:</strong> ${det.situacao}<br>
        ${relator ? `<strong>Relator:</strong> ${relator}<br>` : ""}
        <span class="resultado"><strong>Resultado:</strong> ${voto.resultado || voto.descricao || ""}</span>
      `;
      container.appendChild(div);
    }
  }

  cacheSessaoDOM[ev.id] = container.cloneNode(true);
}

function abrirSessao(id, ev) {
  const box = document.getElementById(`det-${id}`);
  box.classList.toggle("oculto");

  const listaProps = box.querySelector(".lista-props");
  listaProps.innerHTML = "";
  if (cacheSessaoDOM[id]) {
    listaProps.appendChild(cacheSessaoDOM[id].cloneNode(true));
  }
  destacarPalavra(id);
}

/* =====================
   BUSCA
===================== */
function aplicarBusca() {
  const termo = buscaGeral.value.toLowerCase();
  document.querySelectorAll(".evento").forEach(e => {
    const id = e.id.replace("sessao-", "");
    e.querySelector(".sinaliza").innerText =
      termo && cacheSessaoDOM[id]?.textContent.toLowerCase().includes(termo)
        ? " üîç Palavra encontrada" : "";
  });
}

function destacarPalavra(id) {
  const termo = buscaGeral.value;
  if (!termo) return;

  const props = document.querySelectorAll(`#det-${id} .proposicao`);
  const rx = new RegExp(`(${termo})`, "gi");
  props.forEach(p => p.innerHTML = p.innerHTML.replace(rx, "<span class='highlight'>$1</span>"));
}

buscaGeral.addEventListener("input", aplicarBusca);
seletorPeriodo.addEventListener("change", carregarSessoes);

carregarSessoes();
</script>

</body>
</html>
