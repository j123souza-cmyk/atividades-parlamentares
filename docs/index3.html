<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Atividade Parlamentar</title>

<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px }
.container { max-width:1000px; margin:auto; background:#fff; padding:20px; border-radius:6px }
select { width:100%; padding:8px; font-size:1em; margin-bottom:15px }
details { border:1px solid #ccc; border-radius:4px; margin-top:15px; background:#fafafa }
summary { padding:12px; font-weight:bold; background:#e9e9e9; cursor:pointer }
.item { border-left:4px solid #005aa7; padding:10px; margin:10px 0; background:#fff }
.badge { background:#005aa7; color:#fff; padding:4px 8px; border-radius:4px; font-size:.85em }
.loading { color:#666; font-style:italic }
</style>
</head>

<body>
<div class="container">
<h2>Atividade Parlamentar — Dados Oficiais</h2>

<select id="deputado" onchange="carregarDados()">
  <option value="152605">Glauber Braga</option>
  <option value="73433">Jandira Feghali</option>
  <option value="73701">Aécio Neves</option>
</select>

<details open>
<summary>1️⃣ Proposições apresentadas</summary>
<div id="proposicoes" class="loading">Selecione um deputado…</div>
</details>

<details>
<summary>2️⃣ Relação de votações</summary>
<div id="votacoes" class="loading">Selecione um deputado…</div>
</details>
</div>

<script>
const PROXY = "https://api.allorigins.win/raw?url=";
const LEGISLATURA_ATUAL = 57; // 2023–2027

async function carregarDados() {
  const id = document.getElementById("deputado").value;

  document.getElementById("proposicoes").innerHTML = "Carregando proposições reais…";
  document.getElementById("votacoes").innerHTML = "Verificando votações…";

  try {
    const urlProp = PROXY + encodeURIComponent(
      `https://dadosabertos.camara.leg.br/api/v2/deputados/${id}/proposicoes` +
      `?idLegislatura=${LEGISLATURA_ATUAL}&ordem=DESC&ordenarPor=ano&itens=20&pagina=1`
    );

    const res = await fetch(urlProp);
    const json = await res.json();

    if (!json.dados || json.dados.length === 0) {
      document.getElementById("proposicoes").innerHTML =
        "Nenhuma proposição registrada nesta legislatura.";
      document.getElementById("votacoes").innerHTML =
        "Sem votações nominais vinculadas.";
      return;
    }

    // PROPOSIÇÕES
    let htmlProp = `<span class="badge">Total recuperado: ${json.dados.length}</span>`;
    json.dados.slice(0, 6).forEach(p => {
      htmlProp += `
        <div class="item">
          <strong>${p.siglaTipo} ${p.numero}/${p.ano}</strong>
          Ementa: ${p.ementa || "Não informada"}
        </div>`;
    });

    document.getElementById("proposicoes").innerHTML = htmlProp;

    // VOTAÇÕES (amostra simples)
    let htmlVot = "";
    let encontrouVotacao = false;

    for (const p of json.dados.slice(0, 5)) {
      if (!p.id) continue;

      const urlVot = PROXY + encodeURIComponent(
        `https://dadosabertos.camara.leg.br/api/v2/proposicoes/${p.id}/votacoes`
      );

      const vr = await fetch(urlVot);
      const vj = await vr.json();

      if (vj.dados && vj.dados.length > 0) {
        encontrouVotacao = true;
        htmlVot += `
          <div class="item">
            <strong>${p.siglaTipo} ${p.numero}/${p.ano}</strong>
            Possui votação registrada em plenário.
          </div>`;
      }
    }

    document.getElementById("votacoes").innerHTML =
      encontrouVotacao
        ? htmlVot
        : "As proposições listadas não tiveram votação nominal registrada.";

  } catch (e) {
    document.getElementById("proposicoes").innerHTML =
      "Erro ao consultar dados oficiais.";
    document.getElementById("votacoes").innerHTML =
      "Erro ao consultar votações.";
  }
}

carregarDados();
</script>
</body>
</html>
