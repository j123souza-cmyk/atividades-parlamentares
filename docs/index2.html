<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sess√µes do Plen√°rio</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }

#controles {
  margin-bottom: 15px;
  display: flex;
  gap: 20px;
  align-items: center;
}

select, input {
  padding: 6px;
  font-size: 14px;
}

.evento {
  padding: 10px;
  border-bottom: 1px solid #ccc;
  cursor: pointer;
}

.evento:hover { background: #f2f2f2; }

.detalhe {
  margin-top: 8px;
  padding: 10px;
  background: #fafafa;
  border-left: 3px solid #005ea8;
}

.oculto { display: none; }

#status { font-weight: bold; margin-bottom: 10px; }
#progresso { font-weight: bold; margin-bottom: 10px; }

.proposicao { margin-bottom: 14px; }

.resultado { font-style: italic; margin: 4px 0; }

.votos { font-weight: bold; margin-top: 4px; }

.video { margin: 8px 0; }

.highlight { font-weight: bold; color: red; }

.sinaliza { color: blue; font-weight: bold; margin-left: 6px; }

.busca input:disabled { background: #f2f2f2; }
</style>
</head>

<body>

<h2>√öltimas Sess√µes do Plen√°rio</h2>

<div id="progresso">Carregando sess√µes: 0%</div>

<div id="controles">
  <div>
    Per√≠odo:
    <select id="periodo">
      <option value="3" selected>√öltimos 3 meses</option>
      <option value="6">√öltimos 6 meses</option>
    </select>
  </div>

  <div style="flex:1;">
    üîé <input type="text" id="buscaGeral" placeholder="Buscar texto nas sess√µes‚Ä¶" disabled />
  </div>
</div>

<div id="status">Carregando sess√µes‚Ä¶</div>
<div id="lista"></div>

<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";
const status = document.getElementById("status");
const progresso = document.getElementById("progresso");
const lista = document.getElementById("lista");
const seletorPeriodo = document.getElementById("periodo");
const buscaGeral = document.getElementById("buscaGeral");

const cacheProposicoes = {}; // cache das proposi√ß√µes

async function carregarSessoes() {
  lista.innerHTML = "";
  status.innerText = "Carregando sess√µes‚Ä¶";
  buscaGeral.disabled = true;
  progresso.innerText = "Carregando sess√µes: 0%";

  const meses = parseInt(seletorPeriodo.value);
  const fim = new Date();
  const inicio = new Date();
  inicio.setMonth(fim.getMonth() - meses);

  const dataInicio = inicio.toISOString().slice(0,10);
  const dataFim = fim.toISOString().slice(0,10);

  let pagina = 1;
  let sessoes = [];
  let continuar = true;

  while(continuar) {
    const resp = await fetch(`${BASE}/eventos?dataInicio=${dataInicio}&dataFim=${dataFim}&ordenarPor=dataHoraInicio&ordem=DESC&pagina=${pagina}&itens=100`);
    const json = await resp.json();
    const dados = json.dados || [];
    if(!dados.length) break;

    for(const ev of dados) {
      const texto = ((ev.titulo||"") + (ev.descricao||"")).toLowerCase();
      if(texto.includes("sess√£o") && !texto.includes("audi√™ncia") && !texto.includes("mesa") && !texto.includes("semin√°rio")) {
        sessoes.push(ev);
      }
    }
    pagina++;
  }

  status.innerText = sessoes.length ? `Sess√µes encontradas: ${sessoes.length}` : "Nenhuma sess√£o encontrada.";

  sessoes.forEach(criarSessao);

  // Pr√©-carregar proposi√ß√µes e atualizar sinaliza√ß√£o
  let carregadas = 0;
  for(const ev of sessoes) {
    atualizarSinalizacao(ev.id, "‚è≥ Carregando proposi√ß√µes...");
    await preCarregarProposicoes(ev);
    atualizarSinalizacao(ev.id, "");
    carregadas++;
    atualizarProgresso(carregadas, sessoes.length);
  }

  buscaGeral.disabled = false;
  aplicarBusca(); // aplica busca ap√≥s carga
}

// Cria cada sess√£o na lista
function criarSessao(ev) {
  const div = document.createElement("div");
  div.className = "evento";
  div.id = `sessao-${ev.id}`;

  div.innerHTML = `
    <strong>${new Date(ev.dataHoraInicio).toLocaleString()}</strong><span class="sinaliza"></span><br>
    Sess√£o do Plen√°rio
    <div id="det-${ev.id}" class="detalhe oculto"></div>
  `;

  div.onclick = () => abrirSessao(ev, div);
  lista.appendChild(div);
}

// Pr√©-carrega todas as proposi√ß√µes
async function preCarregarProposicoes(ev) {
  if(cacheProposicoes[ev.id]) return;

  const resp = await fetch(`${BASE}/eventos/${ev.id}/votacoes`);
  const votacoes = (await resp.json()).dados || [];
  let html = `<div class="lista-props"></div>`;

  const container = document.createElement('div');
  container.innerHTML = html;
  const listaProps = container.querySelector(".lista-props");

  for(const v of votacoes) {
    const respV = await fetch(`${BASE}/votacoes/${v.id}`);
    const voto = (await respV.json()).dados;
    if(!voto?.proposicoesAfetadas) continue;

    voto.proposicoesAfetadas.forEach(p => {
      const pHtml = document.createElement("div");
      pHtml.className = "proposicao";
      pHtml.innerHTML = `
        ‚û°Ô∏è <strong>
          <a href="https://www.camara.leg.br/proposicoesWeb/fichadetramitacao?idProposicao=${p.id}" target="_blank">
            ${p.siglaTipo} ${p.numero}/${p.ano}
          </a>
        </strong><br>
        ${p.ementa || "Sem ementa"}<br>
        <div class="resultado"><strong>Resultado:</strong> ${voto.resultado || voto.descricao || "Resultado n√£o informado"}</div>
        ${voto.resumoVotacao ? `<div class="votos">${voto.resumoVotacao}</div>` : ""}
      `;
      listaProps.appendChild(pHtml);
    });
  }

  cacheProposicoes[ev.id] = container.innerHTML;
}

// Abre sess√£o
function abrirSessao(ev, bloco) {
  const box = document.getElementById(`det-${ev.id}`);
  box.classList.toggle("oculto");

  if(cacheProposicoes[ev.id]) {
    box.innerHTML = cacheProposicoes[ev.id];
    destacarPalavra(ev.id);
  }
}

// Sinaliza sess√£o individual
function atualizarSinalizacao(evId, texto) {
  const sessao = document.getElementById(`sessao-${evId}`);
  const sinal = sessao.querySelector(".sinaliza");
  sinal.innerText = texto;
}

// Atualiza barra de progresso
function atualizarProgresso(carregadas, total) {
  const pct = Math.round((carregadas / total) * 100);
  progresso.innerText = `Carregando sess√µes: ${carregadas}/${total} (${pct}%)`;
}

// Busca de texto
function aplicarBusca() {
  const termo = buscaGeral.value.trim();
  const termoLower = termo.toLowerCase();

  document.querySelectorAll(".evento").forEach(sessao => {
    const sinal = sessao.querySelector(".sinaliza");
    const sessaoId = sessao.id.replace('sessao-', '');
    sinal.innerText = "";

    if(termo && cacheProposicoes[sessaoId] && cacheProposicoes[sessaoId].toLowerCase().includes(termoLower)) {
      sinal.innerText = " üîç Palavra encontrada";
    }

    // Destaca a palavra se a sess√£o estiver aberta
    const detalhe = document.getElementById(`det-${sessaoId}`);
    if(!detalhe.classList.contains("oculto")) {
      destacarPalavra(sessaoId);
    }
  });
}

// Destaca palavra nas proposi√ß√µes
function destacarPalavra(sessaoId) {
  const termo = buscaGeral.value.trim();
  if(!termo) return;

  const detalhe = document.getElementById(`det-${sessaoId}`);
  if(!detalhe) return;

  // Remove destaques antigos
  detalhe.querySelectorAll(".highlight").forEach(h => {
    const parent = h.parentNode;
    parent.replaceChild(document.createTextNode(h.innerText), h);
    parent.normalize();
  });

  const regex = new RegExp(`(${termo})`, "gi");
  detalhe.querySelectorAll(".proposicao").forEach(p => {
    const walker = document.createTreeWalker(p, NodeFilter.SHOW_TEXT, null, false);
    let node;
    const nodesToReplace = [];
    while(node = walker.nextNode()) {
      if(node.nodeValue.toLowerCase().includes(termo.toLowerCase())) {
        nodesToReplace.push(node);
      }
    }
    nodesToReplace.forEach(textNode => {
      const span = document.createElement('span');
      span.innerHTML = textNode.nodeValue.replace(regex, '<span class="highlight">$1</span>');
      textNode.parentNode.replaceChild(span, textNode);
    });
  });
}

// Eventos
buscaGeral.addEventListener("input", aplicarBusca);
seletorPeriodo.addEventListener("change", carregarSessoes);

// Inicial
carregarSessoes();
</script>

</body>
</html>
