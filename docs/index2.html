<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sessões do Plenário</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#controles { margin-bottom: 15px; }
.evento { padding: 10px; border-bottom: 1px solid #ccc; cursor: pointer; }
.evento:hover { background: #f2f2f2; }
.detalhe { margin-top: 8px; padding: 10px; background: #fafafa; border-left: 3px solid #005ea8; }
.oculto { display: none; }
#status { font-weight: bold; margin-bottom: 10px; }
.placar { margin-top: 6px; font-weight: bold; }
</style>
</head>

<body>

<h2>Últimas Sessões Deliberativas do Plenário</h2>

<div id="controles">
  Período:
  <select id="periodo">
    <option value="3" selected>Últimos 3 meses</option>
    <option value="6">Últimos 6 meses</option>
  </select>
</div>

<div id="status">Carregando sessões…</div>
<div id="lista"></div>

<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";
const status = document.getElementById("status");
const lista = document.getElementById("lista");
const seletor = document.getElementById("periodo");

/* =====================
   CARREGAR SESSÕES
===================== */
async function carregarSessoes() {
  lista.innerHTML = "";
  status.innerText = "Carregando sessões…";

  const meses = parseInt(seletor.value);
  const fim = new Date();
  const inicio = new Date();
  inicio.setMonth(fim.getMonth() - meses);

  const dataInicio = inicio.toISOString().slice(0, 10);
  const dataFim = fim.toISOString().slice(0, 10);

  let pagina = 1;
  let sessoes = [];
  let continuar = true;

  while (continuar) {
    const resp = await fetch(
      `${BASE}/eventos?dataInicio=${dataInicio}&dataFim=${dataFim}` +
      `&ordenarPor=dataHoraInicio&ordem=DESC&pagina=${pagina}&itens=100`
    );

    const json = await resp.json();
    const dados = json.dados || [];
    if (!dados.length) break;

    for (const ev of dados) {
      const dataEv = new Date(ev.dataHoraInicio);
      if (dataEv < inicio) {
        continuar = false;
        break;
      }

      const texto = ((ev.titulo || "") + (ev.descricao || "")).toLowerCase();
      if (texto.includes("sessão") && texto.includes("deliberativa")) {
        sessoes.push(ev);
      }
    }

    pagina++;
  }

  status.innerText = sessoes.length
    ? `Sessões encontradas: ${sessoes.length}`
    : "Nenhuma sessão encontrada.";

  sessoes.forEach(criarSessao);
}

/* =====================
   LISTAGEM
===================== */
function criarSessao(ev) {
  const div = document.createElement("div");
  div.className = "evento";

  div.innerHTML = `
    <strong>${new Date(ev.dataHoraInicio).toLocaleString()}</strong><br>
    Sessão Deliberativa
    <div id="det-${ev.id}" class="detalhe oculto"></div>
  `;

  div.onclick = () => abrirSessao(ev);
  lista.appendChild(div);
}

/* =====================
   ABRIR SESSÃO
===================== */
function abrirSessao(ev) {
  const box = document.getElementById(`det-${ev.id}`);

  if (!box.classList.contains("oculto")) {
    box.classList.add("oculto");
    return;
  }

  box.classList.remove("oculto");
  if (box.dataset.carregado) return;

  box.innerHTML = "Carregando votações…";

  fetch(`${BASE}/eventos/${ev.id}/votacoes`)
    .then(r => r.json())
    .then(res => montarVotacoes(ev, res.dados || [], box))
    .catch(() => box.innerText = "Erro ao carregar votações.");
}

/* =====================
   MONTAR VOTAÇÕES
===================== */
function montarVotacoes(ev, votacoes, box) {

  let html = `
    <strong>Sessão para votação de propostas legislativas</strong><br><br>
    <strong>Local:</strong> Plenário da Câmara dos Deputados<br>
    <strong>Início:</strong> ${new Date(ev.dataHoraInicio).toLocaleString()}<br><br>
  `;

  if (!votacoes.length) {
    box.innerHTML = html + "Nenhuma votação registrada.";
    box.dataset.carregado = "1";
    return;
  }

  html += "<strong>Votações realizadas:</strong><br><br>";
  box.innerHTML = html;

  votacoes.forEach(v => {
    if (!v.proposicoesAfetadas?.length) return;

    v.proposicoesAfetadas.forEach(p => {

      const textoResultado = (v.resultado || v.descricao || "");

      const extrair = (label) => {
        const r = new RegExp(label + "\\s*:?\\s*(\\d+)", "i");
        const m = textoResultado.match(r);
        return m ? parseInt(m[1]) : null;
      };

      const sim = extrair("Sim");
      const nao = extrair("Não");
      const abst = extrair("Abstenção");
      const total = extrair("Total");

      box.innerHTML += `
        ➡️ <strong>${p.siglaTipo} ${p.numero}/${p.ano}</strong><br>
        ${p.ementa || "Sem ementa"}<br>
        <em>Resultado:</em> ${textoResultado || "Não informado"}<br>
        <em>Tipo de votação:</em> Nominal<br>
        ${sim !== null || nao !== null || abst !== null ? `
          <div class="placar">
            Sim: ${sim ?? 0};
            Não: ${nao ?? 0};
            Abstenção: ${abst ?? 0};
            Total: ${total ?? ((sim??0)+(nao??0)+(abst??0))}.
          </div>
        ` : ""}
        <br>
      `;
    });
  });

  box.dataset.carregado = "1";
}

/* =====================
   EVENTOS
===================== */
seletor.addEventListener("change", carregarSessoes);
carregarSessoes();
</script>

</body>
</html>
