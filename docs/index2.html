<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Votações da Câmara</title>

<style>
body { font-family: Arial, sans-serif; margin: 16px; }
h1 { margin-bottom: 10px; }

.votacao {
  border-bottom: 1px solid #ddd;
  padding: 10px 0;
}

.tema { font-size: 14px; }
.resultado { font-size: 13px; color: #555; font-style: italic; }

button {
  margin-top: 6px;
  padding: 6px 10px;
  cursor: pointer;
}

.voto {
  display: flex;
  gap: 10px;
  align-items: center;
  border-bottom: 1px solid #eee;
  padding: 6px 0;
}

.voto img { width: 40px; border-radius: 6px; }

.tag {
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
}
.sim { background: #c8e6c9; }
.nao { background: #ffcdd2; }
.abs { background: #e0e0e0; }
</style>
</head>
<body>

<h1>Votações da Câmara (com tema)</h1>

<div id="status">Carregando votações…</div>
<div id="listaVotacoes"></div>

<hr>

<h2 id="tituloDetalhe"></h2>
<div id="infoDetalhe"></div>
<div id="listaVotos"></div>

<script>
const API = "https://dadosabertos.camara.leg.br/api/v2";
const PROXY = "https://corsproxy.io/?";

const status = document.getElementById("status");
const listaVotacoes = document.getElementById("listaVotacoes");

/* =====================
   LISTAR VOTAÇÕES
===================== */
fetch(PROXY + encodeURIComponent(`${API}/votacoes?ordem=DESC&ordenarPor=dataHoraRegistro&itens=30`))
  .then(r => r.json())
  .then(json => {
    status.innerText = "";

    if (!json.dados || json.dados.length === 0) {
      status.innerText = "Nenhuma votação encontrada.";
      return;
    }

    json.dados
      .filter(v => v.proposicaoObjeto) // só com tema
      .forEach(v => {
        const div = document.createElement("div");
        div.className = "votacao";

        div.innerHTML = `
          <strong>${new Date(v.data).toLocaleDateString()}</strong><br>
          <div class="tema">
            <strong>${v.siglaOrgao || "Órgão"}</strong> — ${v.proposicaoObjeto}
          </div>
          <div class="resultado">${v.descricao || ""}</div>
          <button>Ver votos nominais</button>
        `;

        div.querySelector("button").onclick = () => carregarVotos(v);

        listaVotacoes.appendChild(div);
      });
  })
  .catch(err => {
    console.error(err);
    status.innerText = "Erro ao carregar votações.";
  });

/* =====================
   CARREGAR VOTOS
===================== */
function carregarVotos(v) {
  tituloDetalhe.innerText = `Votação — ${new Date(v.data).toLocaleDateString()}`;
  infoDetalhe.innerHTML = `
    <strong>${v.siglaOrgao}</strong><br>
    ${v.proposicaoObjeto}<br>
    <em>${v.descricao || ""}</em>
  `;

  listaVotos.innerHTML = "Carregando votos…";

  fetch(PROXY + encodeURIComponent(`${API}/votacoes/${v.id}/votos?itens=1000`))
    .then(r => r.json())
    .then(json => {
      const votos = json.dados || [];
      listaVotos.innerHTML = "";

      if (votos.length === 0) {
        listaVotos.innerHTML =
          "Esta votação não foi nominal (simbólica ou sem registro individual).";
        return;
      }

      votos.forEach(vt => {
        let classe = "abs";
        if (vt.voto === "Sim") classe = "sim";
        if (vt.voto === "Não") classe = "nao";

        const div = document.createElement("div");
        div.className = "voto";
        div.innerHTML = `
          <img src="${vt.deputado_.urlFoto}">
          <div>
            <strong>${vt.deputado_.nome}</strong><br>
            ${vt.deputado_.siglaPartido} - ${vt.deputado_.siglaUf}
          </div>
          <span class="tag ${classe}">${vt.voto}</span>
        `;
        listaVotos.appendChild(div);
      });
    })
    .catch(() => {
      listaVotos.innerHTML = "Erro ao carregar votos.";
    });
}
</script>

</body>
</html>
