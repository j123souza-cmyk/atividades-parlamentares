<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sessões do Plenário</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#controles { margin-bottom: 15px; display: flex; gap: 20px; align-items: center; }
select { padding: 5px; }
.evento { padding: 10px; border-bottom: 1px solid #ccc; cursor: pointer; }
.evento:hover { background: #f2f2f2; }
.detalhe { margin-top: 8px; padding: 10px; background: #fafafa; border-left: 3px solid #005ea8; }
.oculto { display: none; }
#status { font-weight: bold; margin-bottom: 10px; }
.proposicao { margin-bottom: 14px; }
.resultado { font-style: italic; margin: 4px 0; }
.votos { font-weight: bold; margin-top: 4px; }
.video { margin: 8px 0; }
</style>
</head>

<body>

<h2>Últimas Sessões do Plenário</h2>

<div id="controles">
  <div>
    Período:
    <select id="periodo">
      <option value="3" selected>Últimos 3 meses</option>
      <option value="6">Últimos 6 meses</option>
    </select>
  </div>

  <div>
    Tipo de proposição:
    <select id="filtroTipo">
      <option value="">Todas</option>
      <option value="PL">PL</option>
      <option value="PEC">PEC</option>
      <option value="PLP">PLP</option>
      <option value="MP">MP</option>
      <option value="PDL">PDL</option>
      <option value="REQ">REQ</option>
    </select>
  </div>
</div>

<div id="status">Carregando sessões…</div>
<div id="lista"></div>

<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";
const lista = document.getElementById("lista");
const status = document.getElementById("status");
const seletorPeriodo = document.getElementById("periodo");
const seletorTipo = document.getElementById("filtroTipo");

/* =====================
   CARREGAR SESSÕES
===================== */
async function carregarSessoes() {
  lista.innerHTML = "";
  status.innerText = "Carregando sessões…";

  const meses = Number(seletorPeriodo.value);
  const fim = new Date();
  const inicio = new Date();
  inicio.setMonth(fim.getMonth() - meses);

  let pagina = 1;
  let exibidas = 0;
  let continuar = true;

  while (continuar) {
    const resp = await fetch(
      `${BASE}/eventos?ordenarPor=dataHoraInicio&ordem=DESC&pagina=${pagina}&itens=100`
    );
    const json = await resp.json();
    const dados = json.dados || [];

    if (!dados.length) break;

    for (const ev of dados) {
      const dataEvento = new Date(ev.dataHoraInicio);
      if (dataEvento < inicio) {
        continuar = false;
        break;
      }

      const texto = ((ev.titulo || "") + (ev.descricao || "")).toLowerCase();
      if (!texto.includes("sessão") || !texto.includes("deliberativa")) continue;

      const temTipo = await sessaoTemTipo(ev.id);
      if (!temTipo) continue;

      criarSessao(ev);
      exibidas++;
    }
    pagina++;
  }

  status.innerText = exibidas
    ? `Sessões encontradas: ${exibidas}`
    : "Nenhuma sessão compatível com o filtro.";
}

/* =====================
   VERIFICAR SE SESSÃO TEM TIPO
===================== */
async function sessaoTemTipo(eventoId) {
  const filtro = seletorTipo.value;
  if (!filtro) return true;

  const resp = await fetch(`${BASE}/eventos/${eventoId}/votacoes`);
  const json = await resp.json();
  const votacoes = json.dados || [];

  for (const v of votacoes) {
    const r = await fetch(`${BASE}/votacoes/${v.id}`);
    const d = await r.json();
    const voto = d.dados;

    if (voto?.proposicoesAfetadas?.some(p => p.siglaTipo === filtro)) {
      return true;
    }
  }
  return false;
}

/* =====================
   LISTAGEM
===================== */
function criarSessao(ev) {
  const div = document.createElement("div");
  div.className = "evento";

  div.innerHTML = `
    <strong>${new Date(ev.dataHoraInicio).toLocaleString()}</strong><br>
    Sessão Deliberativa
    <div id="det-${ev.id}" class="detalhe oculto"></div>
  `;

  div.onclick = () => abrirSessao(ev);
  lista.appendChild(div);
}

/* =====================
   ABRIR SESSÃO
===================== */
function abrirSessao(ev) {
  const box = document.getElementById(`det-${ev.id}`);
  box.classList.toggle("oculto");

  if (box.dataset.carregado) return;

  box.innerHTML = "Carregando votações…";

  fetch(`${BASE}/eventos/${ev.id}/votacoes`)
    .then(r => r.json())
    .then(res => carregarDetalhes(ev, res.dados || [], box));
}

/* =====================
   DETALHES
===================== */
async function carregarDetalhes(ev, votacoes, box) {
  const filtro = seletorTipo.value;

  let html = `
    <strong>Local:</strong> Plenário da Câmara dos Deputados<br>
    <strong>Início:</strong> ${new Date(ev.dataHoraInicio).toLocaleString()}<br>
  `;

  if (ev.urlRegistro || ev.urlTransmissao) {
    const link = ev.urlRegistro || ev.urlTransmissao;
    html += `<div class="video">▶ <a href="${link}" target="_blank">Assistir vídeo</a></div>`;
  }

  box.innerHTML = html + "<br>";

  for (const v of votacoes) {
    const r = await fetch(`${BASE}/votacoes/${v.id}`);
    const d = await r.json();
    const voto = d.dados;

    if (!voto?.proposicoesAfetadas) continue;

    voto.proposicoesAfetadas.forEach(p => {
      if (filtro && p.siglaTipo !== filtro) return;

      box.innerHTML += `
        <div class="proposicao">
          ➡️ <strong>${p.siglaTipo} ${p.numero}/${p.ano}</strong><br>
          ${p.ementa || "Sem ementa"}<br>
          <em>${voto.resultado || voto.descricao || "Resultado não informado"}</em>
        </div>
      `;
    });
  }

  box.dataset.carregado = "1";
}

/* =====================
   EVENTOS
===================== */
seletorPeriodo.addEventListener("change", carregarSessoes);
seletorTipo.addEventListener("change", carregarSessoes);

/* Inicial */
carregarSessoes();
</script>

</body>
</html>
