<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sessões do Plenário</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
}

.evento {
  padding: 10px;
  border-bottom: 1px solid #ccc;
  cursor: pointer;
}

.evento:hover {
  background: #f2f2f2;
}

.detalhe {
  margin-top: 8px;
  padding: 10px;
  background: #fafafa;
  border-left: 3px solid #005ea8;
}

.oculto { display: none; }

#status {
  font-weight: bold;
  margin-bottom: 12px;
}
</style>
</head>

<body>

<h2>Últimas Sessões do Plenário</h2>

<div id="status">Carregando sessões…</div>
<div id="lista"></div>

<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";
const status = document.getElementById("status");
const lista = document.getElementById("lista");

/* Aumenta o período */
const fim = new Date();
const inicio = new Date();
inicio.setMonth(fim.getMonth() - 3);

const dataInicio = inicio.toISOString().slice(0,10);
const dataFim = fim.toISOString().slice(0,10);

/* =====================
   BUSCAR SESSÕES
===================== */
fetch(`${BASE}/eventos?dataInicio=${dataInicio}&dataFim=${dataFim}&ordenarPor=dataHoraInicio&ordem=DESC&itens=300`)
.then(r => r.json())
.then(json => {
  const sessoes = (json.dados || []).filter(e => {
    const t = ((e.titulo || "") + (e.descricao || "")).toLowerCase();
    return t.includes("sessão") && t.includes("deliberativa");
  });

  status.innerText = sessoes.length
    ? "Clique em uma sessão para ver os detalhes"
    : "Nenhuma sessão encontrada.";

  sessoes.forEach(criarSessao);
});

/* =====================
   LISTAGEM
===================== */
function criarSessao(ev) {
  const div = document.createElement("div");
  div.className = "evento";

  div.innerHTML = `
    <strong>${new Date(ev.dataHoraInicio).toLocaleString()}</strong><br>
    Sessão Deliberativa
    <div id="det-${ev.id}" class="detalhe oculto"></div>
  `;

  div.onclick = () => abrirSessao(ev);
  lista.appendChild(div);
}

/* =====================
   DETALHES
===================== */
function abrirSessao(ev) {
  const box = document.getElementById(`det-${ev.id}`);

  if (!box.classList.contains("oculto")) {
    box.classList.add("oculto");
    return;
  }

  box.classList.remove("oculto");

  if (box.dataset.carregado) return;
  box.innerHTML = "Carregando detalhes…";

  Promise.all([
    fetch(`${BASE}/eventos/${ev.id}/pautas`).then(r => r.json()),
    fetch(`${BASE}/eventos/${ev.id}/votacoes`).then(r => r.json())
  ])
  .then(([pautaRes, votRes]) => {
    box.dataset.carregado = "1";

    let html = `
      <strong>Sessão para votação de propostas legislativas</strong><br><br>
      <strong>Local:</strong> Plenário da Câmara dos Deputados<br>
      <strong>Início:</strong> ${new Date(ev.dataHoraInicio).toLocaleString()}<br><br>
    `;

    const pautas = pautaRes.dados || [];
    const votacoes = votRes.dados || [];

    if (pautas.length) {
      html += "<strong>Propostas pautadas:</strong><br>";
      pautas.forEach(p => {
        if (p.proposicao_) {
          html += `➡️ ${p.proposicao_.siglaTipo} ${p.proposicao_.numero}/${p.proposicao_.ano}
            – ${p.proposicao_.ementa || "Sem ementa"}<br>`;
        }
      });
    }
    else if (votacoes.length) {
      html += "<strong>Votações realizadas:</strong><br>";
      votacoes.forEach(v => {
        if (v.proposicaoObjeto_) {
          html += `➡️ ${v.proposicaoObjeto_.siglaTipo} ${v.proposicaoObjeto_.numero}/${v.proposicaoObjeto_.ano}
            – ${v.proposicaoObjeto_.ementa || "Sem ementa"}<br>
            Resultado: ${v.descricao || "Resultado não informado"}<br><br>`;
        }
      });
    }
    else {
      html += "Nenhuma informação legislativa disponível.";
    }

    box.innerHTML = html;
  })
  .catch(() => {
    box.innerText = "Erro ao carregar informações da sessão.";
  });
}
</script>

</body>
</html>
