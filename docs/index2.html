<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sess√µes do Plen√°rio</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }

#controles { margin-bottom: 15px; display: flex; gap: 20px; align-items: center; }
select, input { padding: 6px; font-size: 14px; }

.evento { padding: 10px; border-bottom: 1px solid #ccc; cursor: pointer; }
.evento:hover { background: #f2f2f2; }

.detalhe { margin-top: 8px; padding: 10px; background: #fafafa; border-left: 3px solid #005ea8; }
.oculto { display: none; }

#status { font-weight: bold; margin-bottom: 10px; }

.proposicao { margin-bottom: 14px; }
.resultado { font-style: italic; margin: 4px 0; }
.votos { font-weight: bold; margin-top: 4px; }
.video { margin: 8px 0; }
.busca { margin: 10px 0; width: 100%; }
.busca input { width: 100%; box-sizing: border-box; }
</style>
</head>

<body>

<h2>√öltimas Sess√µes do Plen√°rio</h2>

<div id="controles">
  <div>
    Per√≠odo:
    <select id="periodo">
      <option value="3" selected>√öltimos 3 meses</option>
      <option value="6">√öltimos 6 meses</option>
    </select>
  </div>

  <div class="busca">
    üîé <input type="text" id="buscaGeral" placeholder="Buscar texto nas sess√µes‚Ä¶" />
  </div>
</div>

<div id="status">Carregando sess√µes‚Ä¶</div>
<div id="lista"></div>

<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";
const status = document.getElementById("status");
const lista = document.getElementById("lista");
const seletorPeriodo = document.getElementById("periodo");
const buscaGeral = document.getElementById("buscaGeral");

let sessoesMemoria = []; // guarda sess√µes j√° exibidas e proposi√ß√µes carregadas

/* =====================
   CARREGAR SESS√ïES
===================== */
async function carregarSessoes() {
  lista.innerHTML = "";
  status.innerText = "Carregando sess√µes‚Ä¶";
  sessoesMemoria = [];

  const meses = parseInt(seletorPeriodo.value);
  const fim = new Date();
  const inicio = new Date();
  inicio.setMonth(fim.getMonth() - meses);

  const dataInicio = inicio.toISOString().slice(0, 10);
  const dataFim = fim.toISOString().slice(0, 10);

  let pagina = 1;
  let sessoes = [];
  let continuar = true;

  while (continuar) {
    const resp = await fetch(
      `${BASE}/eventos?dataInicio=${dataInicio}&dataFim=${dataFim}` +
      `&ordenarPor=dataHoraInicio&ordem=DESC&pagina=${pagina}&itens=100`
    );
    const json = await resp.json();
    const dados = json.dados || [];
    if (!dados.length) break;

    for (const ev of dados) {
      const texto = ((ev.titulo || "") + (ev.descricao || "")).toLowerCase();
      if (texto.includes("sess√£o") && texto.includes("deliberativa")) {
        sessoes.push(ev);
      }
    }
    pagina++;
  }

  status.innerText = sessoes.length
    ? `Sess√µes encontradas: ${sessoes.length}`
    : "Nenhuma sess√£o encontrada.";

  sessoes.forEach(criarSessao);
}

/* =====================
   CRIAR SESS√ÉO
===================== */
function criarSessao(ev) {
  const div = document.createElement("div");
  div.className = "evento";
  div.id = `sessao-${ev.id}`;
  div.innerHTML = `
    <strong>${new Date(ev.dataHoraInicio).toLocaleString()}</strong><br>
    Sess√£o do Plen√°rio
    <div id="det-${ev.id}" class="detalhe oculto"></div>
  `;
  div.onclick = () => abrirSessao(ev);
  lista.appendChild(div);
  // inicializa memoria
  sessoesMemoria.push({ sessao: ev, proposicoes: [], carregado: false });
}

/* =====================
   ABRIR SESS√ÉO (lazy load)
===================== */
async function abrirSessao(ev) {
  const box = document.getElementById(`det-${ev.id}`);
  const mem = sessoesMemoria.find(s => s.sessao.id === ev.id);

  box.classList.toggle("oculto");
  if (mem.carregado) return;

  box.innerHTML = "Carregando proposi√ß√µes‚Ä¶";

  try {
    const votacoesResp = await fetch(`${BASE}/eventos/${ev.id}/votacoes`);
    const votacoesJson = await votacoesResp.json();
    const votacoes = votacoesJson.dados || [];
    const props = [];

    for (const v of votacoes) {
      try {
        const respDetalhe = await fetch(`${BASE}/votacoes/${v.id}`);
        const d = await respDetalhe.json();
        const voto = d.dados;
        if (!voto?.proposicoesAfetadas) continue;
        voto.proposicoesAfetadas.forEach(p => {
          props.push({
            id: p.id,
            tipo: p.siglaTipo,
            numero: p.numero,
            ano: p.ano,
            ementa: p.ementa || "Sem ementa",
            resultado: voto.resultado || voto.descricao || "Resultado n√£o informado",
            resumoVotos: voto.resumoVotacao || ""
          });
        });
      } catch(e) { console.error("Erro detalhamento:", e); }
    }

    mem.proposicoes = props;
    mem.carregado = true;

    exibirProposicoes(ev.id, props);
  } catch (e) {
    console.error("Erro ao carregar vota√ß√µes:", e);
    box.innerHTML = "Erro ao carregar proposi√ß√µes.";
  }
}

/* =====================
   EXIBIR PROPOSI√á√ïES
===================== */
function exibirProposicoes(sessaoId, proposicoes) {
  const box = document.getElementById(`det-${sessaoId}`);
  const ev = sessoesMemoria.find(s => s.sessao.id === sessaoId).sessao;

  let html = `
    <strong>Sess√£o para vota√ß√£o de propostas legislativas</strong><br><br>
    <strong>Local:</strong> Plen√°rio da C√¢mara dos Deputados<br>
    <strong>In√≠cio:</strong> ${new Date(ev.dataHoraInicio).toLocaleString()}<br>
  `;

  if (ev.urlRegistro || ev.urlTransmissao) {
    const link = ev.urlRegistro || ev.urlTransmissao;
    html += `<div class="video">‚ñ∂ <a href="${link}" target="_blank">Assistir v√≠deo da sess√£o</a></div>`;
  }

  html += `<div class="lista-props"></div>`;
  box.innerHTML = html;

  const containerProps = box.querySelector(".lista-props");

  for (const p of proposicoes) {
    const pHtml = document.createElement("div");
    pHtml.className = "proposicao";

    pHtml.innerHTML = `
      ‚û°Ô∏è <strong>
        <a href="https://www.camara.leg.br/proposicoesWeb/fichadetramitacao?idProposicao=${p.id}" target="_blank">
          ${p.tipo} ${p.numero}/${p.ano}
        </a>
      </strong><br>
      ${p.ementa}<br>
      <div class="resultado"><strong>Resultado:</strong> ${p.resultado}</div>
      ${p.resumoVotos ? `<div class="votos">${p.resumoVotos}</div>` : ""}
    `;
    containerProps.appendChild(pHtml);
  }
}

/* =====================
   BUSCA
===================== */
buscaGeral.addEventListener("input", () => {
  const termo = buscaGeral.value.trim();
  const termoLower = termo.toLowerCase();

  document.querySelectorAll(".evento").forEach(sessao => {
    const detalhe = sessao.querySelector(".detalhe");
    const sessaoId = parseInt(sessao.id.replace("sessao-", ""));
    const mem = sessoesMemoria.find(s => s.sessao.id === sessaoId);
    if (!mem) return;

    let encontrou = false;

    if (!termo) {
      encontrou = true;
    } else {
      const textoSessao = ((mem.sessao.titulo || "") + " " + (mem.sessao.descricao || "")).toLowerCase();
      if (textoSessao.includes(termoLower)) encontrou = true;

      mem.proposicoes.forEach(p => {
        const textoP = (p.ementa + " " + p.tipo + p.numero + "/" + p.ano + " " + p.resultado + " " + (p.resumoVotos||"")).toLowerCase();
        if (textoP.includes(termoLower)) encontrou = true;
      });
    }

    sessao.style.display = encontrou ? "" : "none";

    // destacar palavra em negrito
    if (encontrou && termo) {
      detalhe.classList.remove("oculto");
      detalhe.querySelectorAll(".proposicao, .resultado, .votos, .video, strong, a").forEach(el => {
        const texto = el.textContent;
        const regex = new RegExp(`(${termo})`, "gi");
        el.innerHTML = texto.replace(regex, "<strong>$1</strong>");
      });
    } else if (!termo) {
      detalhe.classList.add("oculto");
    }
  });
});

/* =====================
   EVENTOS
===================== */
seletorPeriodo.addEventListener("change", carregarSessoes);

/* Inicial */
carregarSessoes();
</script>

</body>
</html>
