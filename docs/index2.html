<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";
const status = document.getElementById("status");
const lista = document.getElementById("lista");

const fim = new Date();
const inicio = new Date();
inicio.setMonth(fim.getMonth() - 2);

const dataInicio = inicio.toISOString().slice(0, 10);
const dataFim = fim.toISOString().slice(0, 10);

/* =========================
   LISTAR SESS√ïES
========================= */
fetch(`${BASE}/eventos?dataInicio=${dataInicio}&dataFim=${dataFim}&ordem=DESC&ordenarPor=dataHoraInicio&itens=200`)
  .then(r => r.json())
  .then(json => {
    status.innerText = "";

    const eventos = (json.dados || []).filter(ev => {
      const txt = ((ev.titulo || "") + " " + (ev.descricao || "")).toLowerCase();
      return txt.includes("sess√£o") && txt.includes("deliberativa");
    });

    if (!eventos.length) {
      status.innerText = "Nenhuma sess√£o encontrada.";
      return;
    }

    eventos.forEach(ev => criarSessao(ev));
  });

/* =========================
   CARD DA SESS√ÉO
========================= */
function criarSessao(ev) {
  const div = document.createElement("div");
  div.className = "evento";

  div.innerHTML = `
    <strong>${new Date(ev.dataHoraInicio).toLocaleString()}</strong>
    ${ev.titulo || "Sess√£o deliberativa"}
    <div id="det-${ev.id}" class="detalhe oculto">Carregando‚Ä¶</div>
  `;

  div.onclick = () => abrirSessao(ev.id, ev.dataHoraInicio);
  lista.appendChild(div);
}

/* =========================
   ABRIR DETALHES
========================= */
function abrirSessao(id, dataHora) {
  const box = document.getElementById(`det-${id}`);
  if (!box.classList.contains("oculto")) {
    box.classList.add("oculto");
    return;
  }

  box.classList.remove("oculto");
  if (box.dataset.ok) return;

  Promise.all([
    fetch(`${BASE}/eventos/${id}`).then(r => r.json()),
    fetch(`${BASE}/eventos/${id}/pautas`).then(r => r.json())
  ])
  .then(([evRes, pautaRes]) => {
    box.dataset.ok = "1";
    const ev = evRes.dados;
    const pautas = pautaRes.dados || [];

    let html = `
      <strong>Sess√£o para vota√ß√£o de propostas legislativas</strong><br><br>
      <strong>Local:</strong> ${ev.local || "Plen√°rio da C√¢mara dos Deputados"}<br>
      <strong>In√≠cio:</strong> ${new Date(dataHora).toLocaleString()}<br><br>
    `;

    if (pautas.length) {
      html += `<strong>Propostas analisadas nesta sess√£o:</strong><br>`;
      pautas.forEach(p => {
        if (p.proposicao_) {
          html += `‚û°Ô∏è ${p.proposicao_.siglaTipo} ${p.proposicao_.numero}/${p.proposicao_.ano}
          ‚Äì ${p.proposicao_.ementa || ""}<br>`;
        }
      });
    } else {
      html += "Nenhuma proposta listada na pauta.";
    }

    if (ev.urlRegistro || ev.uri) {
      html += `<br><a href="${ev.urlRegistro || ev.uri}" target="_blank">
        üîó P√°gina oficial da sess√£o
      </a>`;
    }

    box.innerHTML = html;
  })
  .catch(() => {
    box.innerText = "Erro ao carregar detalhes.";
  });
}
</script>
