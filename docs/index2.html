<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sess√µes do Plen√°rio</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#controles { margin-bottom: 15px; }
.evento { padding: 10px; border-bottom: 1px solid #ccc; cursor: pointer; }
.evento:hover { background: #f2f2f2; }
.detalhe { margin-top: 8px; padding: 10px; background: #fafafa; border-left: 3px solid #005ea8; }
.oculto { display: none; }
#status { font-weight: bold; margin-bottom: 10px; }
.votacao { margin-bottom: 15px; }
.voto-grupo { margin-left: 15px; }
.toggle { color: #005ea8; cursor: pointer; font-size: 13px; }
</style>
</head>

<body>

<h2>√öltimas Sess√µes do Plen√°rio</h2>

<div id="controles">
  Per√≠odo:
  <select id="periodo">
    <option value="3">√öltimos 3 meses</option>
    <option value="6">√öltimos 6 meses</option>
    <option value="12" selected>√öltimos 12 meses</option>
  </select>
</div>

<div id="status">Carregando sess√µes‚Ä¶</div>
<div id="lista"></div>

<script>
const BASE = "https://dadosabertos.camara.leg.br/api/v2";
const status = document.getElementById("status");
const lista = document.getElementById("lista");
const seletor = document.getElementById("periodo");

/* =====================
   BUSCA DE SESS√ïES
===================== */
async function carregarSessoes() {
  lista.innerHTML = "";
  status.innerText = "Carregando sess√µes‚Ä¶";

  const meses = parseInt(seletor.value);
  const fim = new Date();
  const inicio = new Date();
  inicio.setMonth(fim.getMonth() - meses);

  const dataInicio = inicio.toISOString().slice(0, 10);
  const dataFim = fim.toISOString().slice(0, 10);

  let pagina = 1;
  let sessoesFiltradas = [];
  let continuar = true;

  while (continuar) {
    const resp = await fetch(
      `${BASE}/eventos?dataInicio=${dataInicio}&dataFim=${dataFim}` +
      `&ordenarPor=dataHoraInicio&ordem=DESC&pagina=${pagina}&itens=100`
    );
    const json = await resp.json();
    const dados = json.dados || [];
    if (!dados.length) break;

    for (const ev of dados) {
      const dataEvento = new Date(ev.dataHoraInicio);
      if (dataEvento < inicio) { continuar = false; break; }

      const t = ((ev.titulo || "") + (ev.descricao || "")).toLowerCase();
      if (t.includes("sess√£o") && t.includes("deliberativa")) {
        sessoesFiltradas.push(ev);
      }
    }
    pagina++;
  }

  status.innerText = sessoesFiltradas.length
    ? `Sess√µes encontradas: ${sessoesFiltradas.length}`
    : "Nenhuma sess√£o encontrada.";

  sessoesFiltradas.forEach(criarSessao);
}

/* =====================
   LISTAGEM
===================== */
function criarSessao(ev) {
  const div = document.createElement("div");
  div.className = "evento";

  div.innerHTML = `
    <strong>${new Date(ev.dataHoraInicio).toLocaleString()}</strong><br>
    Sess√£o Deliberativa
    <div id="det-${ev.id}" class="detalhe oculto"></div>
  `;

  div.onclick = () => abrirSessao(ev);
  lista.appendChild(div);
}

/* =====================
   DETALHES DA SESS√ÉO
===================== */
function abrirSessao(ev) {
  const box = document.getElementById(`det-${ev.id}`);
  if (!box.classList.contains("oculto")) {
    box.classList.add("oculto");
    return;
  }

  box.classList.remove("oculto");
  if (box.dataset.carregado) return;

  box.innerHTML = "Carregando vota√ß√µes‚Ä¶";

  fetch(`${BASE}/eventos/${ev.id}/votacoes`)
    .then(r => r.json())
    .then(res => carregarDetalhesVotacoes(ev, res.dados || [], box))
    .catch(() => box.innerText = "Erro ao carregar vota√ß√µes.");
}

/* =====================
   VOTA√á√ïES
===================== */
function carregarDetalhesVotacoes(ev, votacoes, box) {

  let html = `
    <strong>Sess√£o para vota√ß√£o de propostas legislativas</strong><br><br>
    <strong>Local:</strong> Plen√°rio da C√¢mara dos Deputados<br>
    <strong>In√≠cio:</strong> ${new Date(ev.dataHoraInicio).toLocaleString()}<br>
  `;

  if (ev.urlVideo || ev.urlRegistro) {
    html += `<strong>V√≠deo:</strong> <a href="${ev.urlVideo || ev.urlRegistro}" target="_blank">Assistir sess√£o</a><br><br>`;
  } else {
    html += `<em>V√≠deo n√£o informado pela API.</em><br><br>`;
  }

  if (!votacoes.length) {
    box.innerHTML = html + "Nenhuma vota√ß√£o registrada.";
    return;
  }

  html += "<strong>Vota√ß√µes realizadas:</strong><br><br>";
  box.innerHTML = html;

  Promise.all(
    votacoes.map(v =>
      fetch(`${BASE}/votacoes/${v.id}`)
        .then(r => r.json())
        .then(d => d.dados)
        .catch(() => null)
    )
  ).then(listaDetalhes => {
    listaDetalhes.forEach(v => {
      if (!v) return;

      const proposicao = v.proposicoesAfetadas?.[0];
      const tema = proposicao?.ementa || v.descricao || "Tema n√£o informado";

      box.innerHTML += `
        <div class="votacao">
          ‚û°Ô∏è <strong>${proposicao ? `${proposicao.siglaTipo} ${proposicao.numero}/${proposicao.ano}` : "Vota√ß√£o"}</strong><br>
          ${tema}<br>
          <strong>Resultado:</strong> ${v.resultado || "N√£o informado"}<br>
          ${v.votos ? `
            <strong>Placar:</strong>
            üëç ${v.votos.SIM || 0} |
            üëé ${v.votos.NAO || 0} |
            ‚ö™ ${v.votos.ABSTENCAO || 0}
            <div class="toggle" onclick="this.nextElementSibling.classList.toggle('oculto')">
              Ver votos nominais
            </div>
            <div class="voto-grupo oculto">
              ${(v.votacao?.map(dep => `${dep.nome} (${dep.voto})`).join("<br>")) || "Detalhamento n√£o dispon√≠vel"}
            </div>
          ` : `<em>Vota√ß√£o n√£o nominal.</em>`}
        </div>
      `;
    });

    box.dataset.carregado = "1";
  });
}

seletor.addEventListener("change", carregarSessoes);
carregarSessoes();
</script>

</body>
</html>
