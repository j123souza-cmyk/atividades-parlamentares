<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sessões do Plenário – Câmara</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: #f7f7f7;
}
h1 { margin-bottom: 10px; }

.filtros {
  margin-bottom: 15px;
}

select, button {
  padding: 6px 10px;
  margin-right: 10px;
  font-size: 14px;
}

.contador {
  margin: 10px 0;
  font-weight: bold;
}

.sessao {
  background: #fff;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 6px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.carregando {
  font-style: italic;
}
</style>
</head>

<body>

<h1>Sessões Deliberativas do Plenário</h1>

<div class="filtros">
  <label>Período:</label>
  <select id="periodo">
    <option value="3" selected>Últimos 3 meses</option>
    <option value="6">Últimos 6 meses</option>
    <option value="12">Últimos 12 meses</option>
  </select>
  <button id="filtrar">Filtrar</button>
</div>

<div id="contador" class="contador"></div>
<div id="resultado">
  <div class="carregando">Carregando sessões...</div>
</div>

<script>
const resultadoEl = document.getElementById("resultado");
const contadorEl = document.getElementById("contador");
const periodoEl = document.getElementById("periodo");
const botaoFiltrar = document.getElementById("filtrar");

botaoFiltrar.addEventListener("click", carregarSessoes);
carregarSessoes(); // padrão: 3 meses

async function carregarSessoes() {
  resultadoEl.innerHTML = '<div class="carregando">Carregando sessões...</div>';
  contadorEl.textContent = "";

  const meses = Number(periodoEl.value);

  const dataFim = new Date();
  const dataInicio = new Date();
  dataInicio.setMonth(dataFim.getMonth() - meses);

  const limiteData = dataInicio.getTime();

  let pagina = 1;
  let todasSessoes = [];
  let continuar = true;

  try {
    while (continuar) {
      const url = `
        https://dadosabertos.camara.leg.br/api/v2/eventos
        ?codTipoEvento=140
        &ordenarPor=dataHoraInicio
        &ordem=DESC
        &itens=100
        &pagina=${pagina}
      `.replace(/\s+/g, "");

      const response = await fetch(url);
      const json = await response.json();
      const dados = json?.dados || [];

      if (dados.length === 0) break;

      for (const sessao of dados) {
        if (!sessao.dataHoraInicio) continue;

        const dataSessao = new Date(sessao.dataHoraInicio).getTime();

        if (dataSessao < limiteData) {
          continuar = false;
          break;
        }

        todasSessoes.push(sessao);
      }

      pagina++;
    }

    if (todasSessoes.length === 0) {
      resultadoEl.innerHTML = "<p>Nenhuma sessão encontrada.</p>";
      contadorEl.textContent = "Sessões encontradas: 0";
      return;
    }

    contadorEl.textContent =
      `Sessões encontradas no período: ${todasSessoes.length}`;

    resultadoEl.innerHTML = "";

    todasSessoes.forEach(sessao => {
      const inicio = sessao.dataHoraInicio
        ? new Date(sessao.dataHoraInicio).toLocaleString("pt-BR")
        : "Não informado";

      const div = document.createElement("div");
      div.className = "sessao";
      div.innerHTML = `
        <strong>${sessao.descricaoTipo || "Sessão Deliberativa"}</strong><br>
        <strong>Local:</strong> ${sessao.localCamara?.nome || "Plenário"}<br>
        <strong>Início:</strong> ${inicio}
      `;
      resultadoEl.appendChild(div);
    });

  } catch (erro) {
    console.error(erro);
    resultadoEl.innerHTML = "<p>Erro ao carregar sessões.</p>";
  }
}
</script>

</body>
</html>
